<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>СПУ-52-3 — калькулятор</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body {
    font-family: Arial, sans-serif;
    background: linear-gradient(#f1b44c, #1f5fff);
    padding: 40px;
  }
  .box {
    background: #ffffffcc;
    border-radius: 12px;
    padding: 20px;
    max-width: 600px;
    margin: auto;
  }
  h1 { margin-top: 0; }
  label { display: block; margin-top: 10px; }
  input {
    width: 100%;
    padding: 6px;
    font-size: 16px;
  }
  button {
    margin-top: 15px;
    padding: 8px 16px;
    font-size: 16px;
  }
  pre {
    background: #eee;
    padding: 10px;
    margin-top: 15px;
    white-space: pre-wrap;
  }
</style>
</head>

<body>

<div class="box">
  <h1>СПУ-52-3</h1>
  <p>Калькулятор по гипсометрической таблице</p>

  <label>P(1000), мм рт.ст.</label>
  <input id="p1000" value="674">

  <label>H, м</label>
  <input id="h" value="200">

  <label>P(H), мм рт.ст.</label>
  <input id="ph" readonly>

  <button id="calc">Рассчитать</button>
  <button id="reset">Сброс</button>

  <pre id="out"></pre>
</div>

<script>
(async function () {

  const DATA_URL = "./spu52.json?v=" + Date.now();

  const p1000El = document.getElementById("p1000");
  const hEl     = document.getElementById("h");
  const phEl    = document.getElementById("ph");
  const outEl   = document.getElementById("out");

  let table = [];

  try {
    const r = await fetch(DATA_URL, { cache: "no-store" });
    const j = await r.json();
    table = j.table
      .map(x => ({ H: Number(x.H), P: Number(x.P) }))
      .sort((a,b) => a.H - b.H);
  } catch (e) {
    outEl.textContent = "Ошибка загрузки spu52.json";
    return;
  }

  function interpP(H) {
    if (H <= table[0].H) return table[0].P;
    if (H >= table[table.length - 1].H) return table[table.length - 1].P;

    for (let i = 0; i < table.length - 1; i++) {
      const a = table[i], b = table[i + 1];
      if (H >= a.H && H <= b.H) {
        const k = (H - a.H) / (b.H - a.H);
        return a.P + k * (b.P - a.P);
      }
    }
  }

  document.getElementById("calc").onclick = () => {
    const P1000 = Number(p1000El.value.replace(",", "."));
    const H = Number(hEl.value.replace(",", "."));

    const Ptab1000 = interpP(1000);
    const PtabH = interpP(H);

    const dP = Ptab1000 - PtabH;
    const PH = P1000 - dP;

    phEl.value = PH.toFixed(3);

    outEl.textContent =
      `H = ${H} м\n` +
      `Pтаб(1000) = ${Ptab1000.toFixed(3)}\n` +
      `Pтаб(H) = ${PtabH.toFixed(3)}\n` +
      `ΔP = ${dP.toFixed(3)}\n` +
      `P(H) = ${PH.toFixed(3)}`;
  };

  document.getElementById("reset").onclick = () => {
    p1000El.value = "";
    hEl.value = "";
    phEl.value = "";
    outEl.textContent = "";
  };

})();
</script>

</body>
</html>
