<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ВУАП-1 — инженерный инструмент</title>
  <style>
    :root{
      --bg0:#070a12;
      --bg1:#0b1430;
      --bg2:#102a4a;
      --card:#0f1b2ee6;
      --card2:#0b1426cc;
      --stroke:#ffffff1a;
      --stroke2:#ffffff12;
      --text:#eaf1ff;
      --muted:#bcd0ffcc;
      --good:#25d18a;
      --bad:#ff4d6d;
      --warn:#ffd166;
      --link:#7cc4ff;

      --shadow: 0 18px 45px rgba(0,0,0,.45);
      --radius: 18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(124,196,255,.25), transparent 55%),
        radial-gradient(900px 600px at 80% 30%, rgba(37,209,138,.18), transparent 55%),
        radial-gradient(1100px 700px at 55% 110%, rgba(255,209,102,.14), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 55%, var(--bg2));
      background-attachment: fixed;
    }

    a{color:var(--link); text-decoration:none}
    a:hover{text-decoration:underline}

    .app{
      max-width: 1320px;
      margin: 0 auto;
      padding: 18px 14px 30px;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:14px;
    }

    .panel{
      background: linear-gradient(180deg, var(--card), var(--card2));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHeader{
      padding:14px 14px 12px;
      border-bottom:1px solid var(--stroke2);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .panelHeader h1, .panelHeader h2{
      margin:0;
      font-weight:800;
      letter-spacing:.2px;
    }
    .panelHeader h1{font-size:16px}
    .panelHeader h2{font-size:15px}
    .sub{
      margin-top:6px;
      color:var(--muted);
      font-size:12.5px;
      line-height:1.35;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }

    .sideBody{padding:12px 12px 14px}
    .toc{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .toc button{
      text-align:left;
      width:100%;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 10px;
      border-radius:14px;
      cursor:pointer;
      font-weight:750;
      font-size:13px;
    }
    .toc button:hover{background: rgba(255,255,255,.07)}
    .toc button.active{
      outline:2px solid rgba(124,196,255,.35);
      background: rgba(124,196,255,.10);
    }

    .hint{
      margin-top:10px;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid var(--stroke2);
      background: rgba(0,0,0,.20);
      color:var(--muted);
      font-size:12.5px;
      line-height:1.35;
    }

    .mainHeader{
      padding:14px 14px 12px;
      border-bottom:1px solid var(--stroke2);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .mainHeader .titleBlock h2{
      margin:0;
      font-size:16px;
      font-weight:900;
    }
    .mainHeader .titleBlock .sub{margin:6px 0 0}
    .mainHeader .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      font-weight:800;
      font-size:13px;
      box-shadow: 0 10px 20px rgba(0,0,0,.22);
      user-select:none;
    }
    .btn:hover{background: rgba(255,255,255,.09)}
    .btn.primary{
      border-color: rgba(124,196,255,.28);
      background: rgba(124,196,255,.14);
    }
    .btn.danger{
      border-color: rgba(255,77,109,.22);
      background: rgba(255,77,109,.12);
    }

    .mainBody{padding:12px 12px 14px}
    .section{
      display:none;
      gap:12px;
    }
    .section.active{display:grid}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    .grid1{display:grid; grid-template-columns: 1fr; gap:12px}

    .card{
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.04);
      border-radius: var(--radius);
      padding:12px;
      box-shadow: 0 12px 24px rgba(0,0,0,.22);
    }
    .card h3{
      margin:0 0 8px 0;
      font-size:14px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .card p{
      margin:0;
      color:var(--muted);
      font-size:12.8px;
      line-height:1.4;
    }

    .kv{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
      font-weight:800;
    }
    input, select{
      width:100%;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid var(--stroke2);
      background: rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
      font-weight:800;
      font-size:13px;
    }
    input::placeholder{color: rgba(234,241,255,.35)}
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:10px;
    }

    .result{
      margin-top:10px;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid var(--stroke2);
      background: rgba(0,0,0,.20);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      font-weight:900;
    }
    .badgeGood{color:var(--good)}
    .badgeBad{color:var(--bad)}
    .badgeWarn{color:var(--warn)}
    .small{font-size:12px; color:var(--muted); font-weight:800}

    .formula{
      margin-top:10px;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.03);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .frac{
      display:inline-grid;
      grid-template-rows:auto auto;
      align-items:center;
      justify-items:center;
      padding:0 8px;
      font-weight:950;
      letter-spacing:.2px;
    }
    .frac .top{border-bottom:2px solid rgba(234,241,255,.55); padding:0 6px 2px}
    .frac .bot{padding:2px 6px 0}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

    details{
      border:1px solid var(--stroke2);
      border-radius: var(--radius);
      background: rgba(255,255,255,.03);
      overflow:hidden;
    }
    summary{
      cursor:pointer;
      padding:12px 12px;
      font-weight:950;
      list-style:none;
    }
    summary::-webkit-details-marker{display:none}
    .detailsBody{padding:0 12px 12px}
    .note{
      margin-top:8px;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid var(--stroke2);
      background: rgba(0,0,0,.18);
      color:var(--muted);
      font-size:12.6px;
      line-height:1.4;
    }

    /* Gallery */
    .galleryTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .galleryInfo{color:var(--muted); font-size:12.5px; font-weight:800}
    .thumbs{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap:8px;
    }
    .thumb{
      border-radius:14px;
      overflow:hidden;
      border:1px solid var(--stroke2);
      background: rgba(0,0,0,.18);
      cursor:pointer;
      aspect-ratio: 3 / 4;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      filter: contrast(1.05) saturate(1.05);
    }
    .thumb .n{
      position:absolute;
      left:8px; top:8px;
      font-weight:950;
      font-size:12px;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid var(--stroke2);
      background: rgba(0,0,0,.35);
      color:var(--text);
      backdrop-filter: blur(6px);
    }

    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.72);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:50;
    }
    .modal.open{display:flex}
    .modalBox{
      max-width: 980px;
      width:100%;
      border-radius: 18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.20);
      background: rgba(10,14,25,.92);
      box-shadow: 0 30px 90px rgba(0,0,0,.6);
    }
    .modalBar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      color:var(--muted);
      font-weight:900;
      font-size:12.5px;
    }
    .modalBar .barBtns{display:flex; gap:8px; flex-wrap:wrap}
    .modalImg{
      width:100%;
      max-height: 78vh;
      object-fit: contain;
      display:block;
      background: rgba(0,0,0,.25);
    }

    @media (max-width: 1100px){
      .app{grid-template-columns: 1fr; }
      .thumbs{grid-template-columns: repeat(4, 1fr);}
    }
    @media (max-width: 520px){
      .thumbs{grid-template-columns: repeat(3, 1fr);}
      .grid2{grid-template-columns: 1fr;}
    }
  </style>
</head>

<body>
  <div class="app">

    <!-- LEFT: navigation -->
    <aside class="panel">
      <div class="panelHeader">
        <div>
          <h1>ВУАП-1</h1>
          <div class="sub">Электронная инженерная инструкция + расчёты</div>
        </div>
        <div class="pill">Mi Avionics Tools</div>
      </div>

      <div class="sideBody">
        <div class="toc" id="toc">
          <button class="active" data-target="sec-intro">1) Вход и условия</button>
          <button data-target="sec-checks">2) Проверки и расчёты</button>
          <button data-target="sec-reg">3) Регулировка</button>
          <button data-target="sec-gallery">4) Технология (фото)</button>
        </div>

        <div class="hint">
          Здесь всё работает как приложение: выбрал раздел слева → работаешь справа.
        </div>

        <div class="hint">
          <b>Назад в меню:</b> <a href="./index.html">главная</a>
        </div>
      </div>
    </aside>

    <!-- RIGHT: content -->
    <main class="panel">
      <div class="mainHeader">
        <div class="titleBlock">
          <h2 id="pageTitle">ВУАП-1 — инженерный инструмент</h2>
          <div class="sub">Пошагово: условия → проверки → расчёты → решение “допуск/недопуск”.</div>
        </div>
        <div class="actions">
          <button class="btn danger" id="btnResetAll" type="button">Сбросить ввод</button>
          <button class="btn primary" id="btnOpenTech" type="button">Открыть технологию</button>
        </div>
      </div>

      <div class="mainBody">

        <!-- SECTION 1 -->
        <section class="section active" id="sec-intro">
          <div class="grid2">
            <div class="card">
              <h3>0. Назначение</h3>
              <p>
                Этот инструмент — не просто “картинки технологии”.
                Он предназначен для внесения измерений и автоматического расчёта передаточных/контрольных параметров
                с оценкой допуска.
              </p>

              <details style="margin-top:10px" open>
                <summary>Нулевые условия (заполняется инженером)</summary>
                <div class="detailsBody">
                  <div class="kv">
                    <div>
                      <label>Температура окружения (°C)</label>
                      <input id="ambTemp" inputmode="decimal" placeholder="например 20" />
                    </div>
                    <div>
                      <label>Питание / условия стенда</label>
                      <input id="standCond" placeholder="например питание 27В, стенд …" />
                    </div>
                    <div>
                      <label>Изделие</label>
                      <input id="unitId" placeholder="серия/№/вертолёт" />
                    </div>
                    <div>
                      <label>Инженер</label>
                      <input id="engineer" placeholder="ФИО" />
                    </div>
                  </div>

                  <div class="note">
                    Это блок “как в регламенте”: сначала зафиксировать условия, потом — измерения.
                  </div>
                </div>
              </details>
            </div>

            <div class="card">
              <h3>1. Как работать</h3>
              <p>
                1) Перейди в “Проверки и расчёты”.<br/>
                2) Выбери тип проверки и введи “вход” и “выход”.<br/>
                3) Получишь K и статус допуска.<br/>
                4) Открой “Технология (фото)” и сверяйся с пунктами.
              </p>

              <div class="formula" title="Общий вид формулы">
                <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
                  <span style="font-weight:950">Передаточное число:</span>
                  <span class="frac" aria-label="K = |Выход| / |Вход|">
                    <span class="top mono">|Выход|</span>
                    <span class="bot mono">|Вход|</span>
                  </span>
                  <span class="mono">K =</span>
                  <span class="mono">|Y| / |X|</span>
                </div>
                <div class="small">модуль • 3 знака</div>
              </div>

              <div class="note">
                ВУАП-1 мы оформляем “как приложение”: структура слева, расчёт справа, технология открывается отдельным блоком.
              </div>
            </div>
          </div>
        </section>

        <!-- SECTION 2 -->
        <section class="section" id="sec-checks">
          <div class="grid2">

            <div class="card">
              <h3>2.1 Быстрый расчёт передаточного числа</h3>
              <p>Введи значения. Отрицательные знаки не важны — берётся модуль.</p>

              <div class="kv">
                <div>
                  <label>Тип проверки</label>
                  <select id="checkType">
                    <option value="linear">Линейная (мм/мм)</option>
                    <option value="angular">Угловая (°/°)</option>
                    <option value="mixed">Комбинированная (по технологии)</option>
                  </select>
                </div>
                <div>
                  <label>Канал</label>
                  <select id="channel">
                    <option value="pitch">Тангаж</option>
                    <option value="roll">Крен</option>
                    <option value="yaw">Курс</option>
                  </select>
                </div>

                <div>
                  <label>Вход X</label>
                  <input id="xIn" inputmode="decimal" placeholder="например 5.0" />
                </div>
                <div>
                  <label>Выход Y</label>
                  <input id="yOut" inputmode="decimal" placeholder="например 12.5" />
                </div>

                <div>
                  <label>Kном</label>
                  <input id="kNom" inputmode="decimal" placeholder="например 2.500" />
                </div>
                <div>
                  <label>Допуск ±</label>
                  <input id="kTol" inputmode="decimal" placeholder="например 0.200" />
                </div>
              </div>

              <div class="row">
                <button class="btn primary" type="button" id="btnCalc">Рассчитать</button>
                <button class="btn" type="button" id="btnAddRow">Добавить в журнал</button>
              </div>

              <div class="result" id="resultBox">
                <div>
                  <div style="font-size:13px; font-weight:950">K = <span class="mono" id="kValue">—</span></div>
                  <div class="small" id="kMath">|Y| / |X|</div>
                </div>
                <div style="text-align:right">
                  <div style="font-size:13px; font-weight:950" id="kStatus">—</div>
                  <div class="small" id="kRange">—</div>
                </div>
              </div>

              <div class="note">
                Это “универсальный калькулятор”. Дальше (следующим шагом) мы привяжем его к конкретным пунктам технологии:
                “шаг → что задать → что измерить → какая норма”.
              </div>
            </div>

            <div class="card">
              <h3>2.2 Журнал измерений</h3>
              <p>Сохраняй ключевые результаты, чтобы потом иметь итог “годен/не годен”.</p>

              <div style="overflow:auto; margin-top:10px; border-radius:14px; border:1px solid var(--stroke2);">
                <table style="width:100%; border-collapse:collapse; min-width:760px; background:rgba(0,0,0,.18)">
                  <thead>
                    <tr style="text-align:left; font-size:12px; color:var(--muted)">
                      <th style="padding:10px 10px; border-bottom:1px solid var(--stroke2)">Время</th>
                      <th style="padding:10px 10px; border-bottom:1px solid var(--stroke2)">Канал</th>
                      <th style="padding:10px 10px; border-bottom:1px solid var(--stroke2)">Тип</th>
                      <th style="padding:10px 10px; border-bottom:1px solid var(--stroke2)">X</th>
                      <th style="padding:10px 10px; border-bottom:1px solid var(--stroke2)">Y</th>
                      <th style="padding:10px 10px; border-bottom:1px solid var(--stroke2)">K</th>
                      <th style="padding:10px 10px; border-bottom:1px solid var(--stroke2)">Норма</th>
                      <th style="padding:10px 10px; border-bottom:1px solid var(--stroke2)">Статус</th>
                    </tr>
                  </thead>
                  <tbody id="logBody"></tbody>
                </table>
              </div>

              <div class="row">
                <button class="btn" type="button" id="btnClearLog">Очистить журнал</button>
                <button class="btn" type="button" id="btnExport">Экспорт (CSV)</button>
              </div>

              <div class="note">
                Журнал хранится в браузере (localStorage). Это удобно для работы “для себя и коллег”.
              </div>
            </div>

          </div>
        </section>

        <!-- SECTION 3 -->
        <section class="section" id="sec-reg">
          <div class="grid1">
            <div class="card">
              <h3>3. Регулировка (структура)</h3>
              <p>
                Этот раздел — “карта регулировки”: что разрешено крутить, что запрещено, и обязательный повторный контроль.
                Мы заполним его пунктами из технологии после привязки шагов.
              </p>

              <details style="margin-top:10px">
                <summary>Правило</summary>
                <div class="detailsBody">
                  <div class="note">
                    Если K вне допуска → выполняется регулировка → повтор проверки → запись в журнал.
                  </div>
                </div>
              </details>

              <details style="margin-top:10px">
                <summary>Запись регулировки (черновик)</summary>
                <div class="detailsBody">
                  <div class="kv">
                    <div>
                      <label>Что регулировали</label>
                      <input id="regWhat" placeholder="например тяга …" />
                    </div>
                    <div>
                      <label>Сколько (обороты/мм)</label>
                      <input id="regHowMuch" placeholder="например +0.5 оборота" />
                    </div>
                    <div style="grid-column:1 / -1">
                      <label>Комментарий</label>
                      <input id="regComment" placeholder="кратко: причина, результат" />
                    </div>
                  </div>
                  <div class="row">
                    <button class="btn primary" type="button" id="btnSaveReg">Сохранить запись</button>
                    <button class="btn" type="button" id="btnClearReg">Сброс</button>
                  </div>
                  <div class="note" id="regSaved" style="display:none"></div>
                </div>
              </details>
            </div>
          </div>
        </section>

        <!-- SECTION 4 -->
        <section class="section" id="sec-gallery">
          <div class="grid1">

            <div class="card">
              <h3>4. Технология (фото)</h3>
              <p>Фото подтягиваются автоматически из папки <span class="mono">vuap1/assets/tech</span>.</p>

              <div class="galleryTop" style="margin-top:10px">
                <div class="galleryInfo" id="galInfo">Загрузка списка файлов…</div>
                <div class="row" style="margin-top:0">
                  <button class="btn" type="button" id="btnPrev">Назад</button>
                  <button class="btn" type="button" id="btnNext">Вперёд</button>
                </div>
              </div>

              <div class="thumbs" id="thumbs"></div>

              <div class="note">
                Если миниатюры не появились — значит GitHub API не видит папку или файлы не в <span class="mono">vuap1/assets/tech</span>.
              </div>
            </div>

          </div>
        </section>

      </div>
    </main>

  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="modalBox">
      <div class="modalBar">
        <div id="modalTitle">—</div>
        <div class="barBtns">
          <button class="btn" type="button" id="mPrev">Назад</button>
          <button class="btn" type="button" id="mNext">Вперёд</button>
          <button class="btn danger" type="button" id="mClose">Закрыть</button>
        </div>
      </div>
      <img class="modalImg" id="modalImg" alt="Технология ВУАП-1" />
    </div>
  </div>

<script>
(() => {
  // === SETTINGS (твой репозиторий) ===
  const OWNER = "korotkovmykola11-cmd";
  const REPO  = "Mi-Avionics-Tools";
  const BRANCH = "main";
  const TECH_DIR = "vuap1/assets/tech"; // папка с 69 фото

  // === UI: navigation ===
  const toc = document.getElementById("toc");
  const sections = [...document.querySelectorAll(".section")];
  toc.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-target]");
    if(!btn) return;
    toc.querySelectorAll("button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    const id = btn.dataset.target;
    sections.forEach(s => s.classList.toggle("active", s.id === id));
    if(id === "sec-gallery") { ensureGallery(); }
  });

  // top buttons
  document.getElementById("btnOpenTech").addEventListener("click", () => {
    toc.querySelector('button[data-target="sec-gallery"]').click();
  });

  // === Calc ===
  const xIn = document.getElementById("xIn");
  const yOut = document.getElementById("yOut");
  const kNom = document.getElementById("kNom");
  const kTol = document.getElementById("kTol");
  const kValue = document.getElementById("kValue");
  const kStatus = document.getElementById("kStatus");
  const kRange = document.getElementById("kRange");
  const kMath = document.getElementById("kMath");
  const resultBox = document.getElementById("resultBox");

  const toNum = (v) => {
    if(v == null) return NaN;
    const s = String(v).trim().replace(",", ".");
    if(!s) return NaN;
    const n = Number(s);
    return Number.isFinite(n) ? n : NaN;
  };

  function setStatus(text, cls){
    kStatus.textContent = text;
    kStatus.className = "";
    if(cls) kStatus.classList.add(cls);
  }

  function calcK(){
    const X = Math.abs(toNum(xIn.value));
    const Y = Math.abs(toNum(yOut.value));
    if(!(X > 0) || !(Y > 0)){
      kValue.textContent = "—";
      kMath.textContent = "|Y| / |X|";
      setStatus("—");
      kRange.textContent = "—";
      return null;
    }
    const K = Y / X;
    const K3 = Math.round(K * 1000) / 1000;

    kValue.textContent = K3.toFixed(3);
    kMath.textContent = `|${Y.toFixed(3)}| / |${X.toFixed(3)}|`;

    const nom = toNum(kNom.value);
    const tol = Math.abs(toNum(kTol.value));

    if(Number.isFinite(nom) && Number.isFinite(tol) && tol >= 0){
      const lo = nom - tol;
      const hi = nom + tol;
      kRange.textContent = `Норма: ${lo.toFixed(3)} … ${hi.toFixed(3)}`;
      if(K >= lo && K <= hi){
        setStatus("В ДОПУСКЕ", "badgeGood");
      } else {
        setStatus("ВНЕ ДОПУСКА", "badgeBad");
      }
    } else {
      kRange.textContent = "Норма: —";
      setStatus("РАССЧИТАНО", "badgeWarn");
    }
    return {X, Y, K: K3};
  }

  document.getElementById("btnCalc").addEventListener("click", calcK);

  // Auto-calc on input
  [xIn, yOut, kNom, kTol].forEach(el => el.addEventListener("input", () => calcK()));

  // === Log ===
  const logBody = document.getElementById("logBody");
  const keyLog = "vuap1_log_v1";
  function loadLog(){
    logBody.innerHTML = "";
    const raw = localStorage.getItem(keyLog);
    if(!raw) return;
    let arr = [];
    try{ arr = JSON.parse(raw); } catch { arr = []; }
    arr.forEach(addRowToTable);
  }
  function saveLog(arr){
    localStorage.setItem(keyLog, JSON.stringify(arr));
  }
  function addRowToTable(r){
    const tr = document.createElement("tr");
    const td = (t) => {
      const c = document.createElement("td");
      c.style.padding = "10px 10px";
      c.style.borderBottom = "1px solid rgba(255,255,255,.10)";
      c.textContent = t;
      return c;
    };
    tr.appendChild(td(r.time));
    tr.appendChild(td(r.channel));
    tr.appendChild(td(r.type));
    tr.appendChild(td(r.x));
    tr.appendChild(td(r.y));
    tr.appendChild(td(r.k));
    tr.appendChild(td(r.norm));
    const st = td(r.status);
    st.style.fontWeight = "950";
    st.style.color = r.status.includes("ДОПУСКЕ") ? "rgba(37,209,138,1)" : "rgba(255,77,109,1)";
    tr.appendChild(st);
    logBody.appendChild(tr);
  }

  document.getElementById("btnAddRow").addEventListener("click", () => {
    const res = calcK();
    if(!res) return;
    const type = document.getElementById("checkType").value;
    const channel = document.getElementById("channel").value;

    const nom = toNum(kNom.value);
    const tol = Math.abs(toNum(kTol.value));
    const normTxt = (Number.isFinite(nom) && Number.isFinite(tol))
      ? `${(nom-tol).toFixed(3)}…${(nom+tol).toFixed(3)}`
      : "—";

    const statusTxt = kStatus.textContent || "—";

    const row = {
      time: new Date().toLocaleString(),
      channel: channel,
      type: type,
      x: Math.abs(toNum(xIn.value)).toFixed(3),
      y: Math.abs(toNum(yOut.value)).toFixed(3),
      k: (res.K).toFixed(3),
      norm: normTxt,
      status: statusTxt
    };

    let arr = [];
    try{ arr = JSON.parse(localStorage.getItem(keyLog) || "[]"); } catch { arr = []; }
    arr.push(row);
    saveLog(arr);
    addRowToTable(row);
  });

  document.getElementById("btnClearLog").addEventListener("click", () => {
    localStorage.removeItem(keyLog);
    loadLog();
  });

  document.getElementById("btnExport").addEventListener("click", () => {
    let arr = [];
    try{ arr = JSON.parse(localStorage.getItem(keyLog) || "[]"); } catch { arr = []; }
    const head = ["time","channel","type","x","y","k","norm","status"];
    const lines = [head.join(",")].concat(arr.map(r => head.map(k => `"${String(r[k]||"").replaceAll('"','""')}"`).join(",")));
    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "vuap1-log.csv";
    a.click();
    URL.revokeObjectURL(url);
  });

  // === Reg record ===
  const regSaved = document.getElementById("regSaved");
  document.getElementById("btnSaveReg").addEventListener("click", () => {
    const what = document.getElementById("regWhat").value.trim();
    const how = document.getElementById("regHowMuch").value.trim();
    const com = document.getElementById("regComment").value.trim();
    const msg = `Сохранено: ${what || "—"} / ${how || "—"} / ${com || "—"}`;
    regSaved.style.display = "block";
    regSaved.textContent = msg;
  });
  document.getElementById("btnClearReg").addEventListener("click", () => {
    ["regWhat","regHowMuch","regComment"].forEach(id => document.getElementById(id).value = "");
    regSaved.style.display = "none";
  });

  // === Reset all inputs ===
  document.getElementById("btnResetAll").addEventListener("click", () => {
    ["ambTemp","standCond","unitId","engineer","xIn","yOut","kNom","kTol"].forEach(id => {
      const el = document.getElementById(id);
      if(el) el.value = "";
    });
    calcK();
  });

  // === Gallery (auto from GitHub) ===
  let galleryLoaded = false;
  let files = [];
  let page = 0;
  const perPage = 18;

  const galInfo = document.getElementById("galInfo");
  const thumbs = document.getElementById("thumbs");

  const modal = document.getElementById("modal");
  const modalImg = document.getElementById("modalImg");
  const modalTitle = document.getElementById("modalTitle");
  let modalIndex = 0;

  function isImg(name){
    const n = name.toLowerCase();
    return n.endsWith(".jpg") || n.endsWith(".jpeg") || n.endsWith(".png") || n.endsWith(".webp");
  }

  async function loadFilesFromGitHub(){
    const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${encodeURIComponent(TECH_DIR)}?ref=${BRANCH}`;
    const r = await fetch(url, {headers: {"Accept":"application/vnd.github+json"}});
    if(!r.ok) throw new Error("GitHub API error");
    const arr = await r.json();
    const imgs = arr
      .filter(x => x && x.type === "file" && isImg(x.name))
      .map(x => ({name: x.name, download_url: x.download_url}))
      .sort((a,b) => a.name.localeCompare(b.name, "ru"));
    return imgs;
  }

  function renderPage(){
    thumbs.innerHTML = "";
    const start = page * perPage;
    const slice = files.slice(start, start + perPage);
    galInfo.textContent = files.length
      ? `Файлов: ${files.length} • Показ: ${start+1}–${Math.min(start+perPage, files.length)}`
      : "Файлы не найдены в папке";

    slice.forEach((f, i) => {
      const idx = start + i;
      const d = document.createElement("div");
      d.className = "thumb";
      d.title = f.name;
      d.innerHTML = `<span class="n">${idx+1}</span><img loading="lazy" alt="${f.name}" />`;
      const img = d.querySelector("img");
      img.src = f.download_url;

      d.addEventListener("click", () => openModal(idx));
      thumbs.appendChild(d);
    });
  }

  function openModal(idx){
    modalIndex = idx;
    const f = files[modalIndex];
    modalTitle.textContent = `${modalIndex+1} / ${files.length} — ${f.name}`;
    modalImg.src = f.download_url;
    modal.classList.add("open");
  }

  function closeModal(){ modal.classList.remove("open"); }

  document.getElementById("btnPrev").addEventListener("click", () => {
    if(page > 0){ page--; renderPage(); }
  });
  document.getElementById("btnNext").addEventListener("click", () => {
    const maxPage = Math.max(0, Math.ceil(files.length / perPage) - 1);
    if(page < maxPage){ page++; renderPage(); }
  });

  document.getElementById("mClose").addEventListener("click", closeModal);
  modal.addEventListener("click", (e) => { if(e.target === modal) closeModal(); });

  document.getElementById("mPrev").addEventListener("click", () => {
    if(modalIndex > 0) openModal(modalIndex - 1);
  });
  document.getElementById("mNext").addEventListener("click", () => {
    if(modalIndex < files.length - 1) openModal(modalIndex + 1);
  });

  async function ensureGallery(){
    if(galleryLoaded) return;
    galleryLoaded = true;
    try{
      galInfo.textContent = "Загрузка списка файлов…";
      files = await loadFilesFromGitHub();
      page = 0;
      renderPage();
    } catch (e){
      galInfo.textContent = "Не удалось загрузить файлы. Проверь папку vuap1/assets/tech и права доступа.";
    }
  }

  // load saved log
  loadLog();
  // init calc
  calcK();
})();
</script>
</body>
</html>
